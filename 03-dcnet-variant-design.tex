\chapter{Diseño de la variante \emph{DC-Net}}
\section{Glosario de Términos}

\begin{itemize}
    \item Participante: agente que participa activamente del protocolo, ya sea enviando un mensaje o contribuyendo para aumentar el tamaño del \emph{anonimity-set} y así ocultar ``de mejor manera'' a los emisores de mensajes. 
    \item Ronda: serie de pasos (descritos a partir de la próxima sección) que se llevan a cabo (principalmente intercambiando mensajes entre los participantes) con el objetivo de ir reduciendo ronda a ronda los mensajes enviados por cada participante.  
    \item Mensaje: información que cada participante desea transmitir de manera anónima. Generalmente se relacionará a un conjunto de caracteres (representados como \emph{String}), en un cierto idioma, que se desea enviar.
    \item Sesión: conjunto de rondas que se necesitan realizar para que pueda ser transmitido, a lo más, un mensaje por participante. Al principio de cada sesión, se le da la oportunidad a cada participante de decidir si enviará o no un mensaje. Luego que cada participante realizó su decisión, se inicia el protocolo descrito a continuación, que tiene como objetivo que cada uno de los mensajes que se decidieron enviar, se envíen de manera anónima al resto de los participantes.
    \item Sala: conjunto de participantes corriendo una sesión del protocolo.
    \item Observador Externo: cualquier agente (a excepción de los propios participantes) que pueda estar monitoreando, tanto los mensajes resultantes del protocolo, como mensajes intermedios intercambiados entre los distintos participantes durante la realización del protocolo. A no ser que se explicite, todos los mensajes del protocolo pueden ser monitoreados por un observador externo.
    \item Adversario: agente que tiene como finalidad, ya sea encontrar al emisor de un cierto mensaje, o bien, alterar el comportamiento ``normal'' del protocolo (retrasándolo o impidiendo su total realización). Este adversario puede ser un mismo participante del protocolo (al cual llamaremos participante malicioso) o un observador externo.
\end{itemize}

\section{Diseño a primera vista}
\section{Compartición de Llaves}

Una ronda real comienza con el proceso de compartición de llaves entre cada par de participantes presentes en la sala. Este proceso debe realizarse, tomando un cuenta un posible adversario que esté monitoreando el canal de comunicación existente entre dos participantes cualquiera.

Para solucionar este problema se propone el uso del algoritmo \emph{Diffie-Hellman} \cite{diffie1976new} que permite generar un valor secreto compartido entre dos agentes, cuyo canal de comunicación es monitoreado por un adversario.

Luego que cada par de participantes $\{P_i, P_j\}$ ejecuten el algoritmo \emph{Diffie-Hellman}, obtendrán un valor secreto $k_{ij}$. Para futuros pasos del protocolo, es necesario que ejecuten este proceso dos veces, ya que es necesario que cuenten con un segundo valor compartido $r^k_{ij}$.

\subsection{\emph{Commitments} sobre las llaves}

Posteriormente cada participante $P_i$ debe realizar un \emph{commitment} a cada valor $k_{ij}$ que posee compartido con cada otro participante $P_j$, utilizando como aleatoriedad el segundo valor compartido, $r^k_{ij}$. Esto resulta en que cada participante posee $n - 1$ de los siguientes valores $c_{k_{ij}} = g^{k_{ij}} h^{r^k_{ij}}$.

Luego de esto, cada participante $P_i$ generará dos valores, el primero será la suma de todas las llaves compartidas que posee $K_i = \sum k_{ij}$. El segundo valor será un \emph{commitment} sobre dicho valor, esto es, $c_{K_i} = \prod c_{k_{ij}}$.

Finalmente cada participante $P_i$ enviará al resto de la sala vía \emph{broadcast} su \emph{commitment} $c_{K_i}$ junto con una \emph{zero-knowledge proof} demostrando que conoce los valores ``escondidos'' dentro del \emph{commitment}.

\subsection{Verificación de los valores enviados}

\todoline{Verificar zkp, multiplicacion de commitments de llaves y como encontrar al culpable}

\section{Formato del Mensaje}

Al principio de una sesión, cada participante $P_i$ debe decidir si desea comunicar un mensaje $msg$ al resto de la sala o no. De querer enviar un mensaje, habrán rondas que deberá enviar $m_i = msg$, y otras que enviará $m_i = 0$. De no querer transmitir un mensaje, en todas las rondas enviará $m_i = 0$. 

Para que el protocolo funcione correctamente, es necesario que dicho mensaje $m_i$ se concatene con otros valores, permitiendo el correcto manejo de colisiones de mensajes (es explicado más adelante en el documento). Estos valores auxiliares son los siguientes:
\begin{itemize}
    \item $b_i$: bit que indica si el participante esta, en la presente ronda, enviando un mensaje distinto a cero o no ($b_i = 1 \iff m_i \neq 0$).
    \item $pad_i$: cadena de bits aleatoria que se añade para prevenir colisión de mensajes iguales, que podría desembocar en que la sesión nunca finalice.
\end{itemize}

Con estos valores establecidos, en cada ronda cada participante $P_i$ debe formar el siguiente valor $M_i$:

\todoline{agregar diagrama de $M_i$}

\section{Correctitud del Formato del Mensaje}

Para que el protocolo tenga un correcto funcionamiento en el manejo de colisiones, es imperioso que el formato del mensaje $M_i$ se respete por todos los participantes. Para ello se debe satisfacer una de las siguientes restricciones:
\begin{itemize}
    \item Si $b_i = 0$, entonces $m_i = 0$
    \item $b_i = 1$
\end{itemize}
En la primera alternativa, se le fuerza al participante a que si esta diciendo que no envía un mensaje ($b_i = 0$), no lo envíe ($m_i = 0$). En la segunda opción, se le permite cualquier valor de $m_i$ siempre y cuando se cumpla que $b_i = 1$.

\subsection{\emph{Commitments} sobre los valores individuales}

Para poder demostrar que su mensaje $M_i$ posee un correcto formato, es necesario primero realizar \emph{commitments} a cada uno de los valores $\{m_i, pad_i, b_i\}$. Para ello, se escogen valores aleatorios $\{r_i^m, r_i^{pad}, r_i^b\}$ y se calculan los valores $c_{m_i} = g^{m_i} h^{r_i^m}; c_{pad_i} = g^{pad_i} h^{r_i^{pad}}; c_{b_i} = g^{b_i} h^{r_i^b}$ (\emph{commitments} a los valores individuales anteriormente descritos).

\subsection{\emph{Zero-knowledge Proof} sobre formato del mensaje}

\section{Demostración de conocimiento del mensaje}
\section{Envío del mensaje de salida}
\subsection{Ronda 1}
\subsection{Rondas posteriores}
\section{Ronda Virtual}
\section{Resolución de la ronda}
\subsection{Primera colisión}
\subsection{Ronda sin colisión}
\subsection{Resolución de colisiones}
\section{Observación sobre tamaño de mensajes}